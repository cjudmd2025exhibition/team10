<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
        <link rel="stylesheet" href="../css/style.css">
        <link rel="stylesheet" href="../css/header.css">
        <link rel="stylesheet" href="./css/quiz.css">
        <title>MOONY_INFO</title>
    </head>
    <body>
        <!-- ============================================ -->
        <!-- HEADER START - 다른 페이지 복사 시 이 영역만 복사 -->
        <!-- ============================================ -->
        
        <!-- Menu Overlay -->
        <div class="menu-overlay"></div>
    
        <!-- Header -->
        <header>
            <div class="head-container">
            <!-- Logo -->
            <a href="../index.html" class="header-logo-link">
                <img src="../img/작은 로고.png" alt="로고" class="header-logo">
            </a>
                
                <!-- Mobile Menu Button -->
                <button class="menu-btn" aria-label="메뉴">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
    
            <!-- Navigation -->
            <nav class="nav">
                <a href="../sub/sub.html" class="nav-link nav-link-1">달의 위상?</a>
                <a href="../info/info.html" class="nav-link nav-link-2">다양한 달의 정보</a>
                <a href="../quiz/quiz.html" class="nav-link nav-link-3">달 관련 퀴즈</a>
                <a href="../diary/diary.html" class="nav-link nav-link-4">달 관찰 일지 작성</a>
                <!-- Mobile Login Button (inside nav) -->
                <button class="login-btn login-btn-mobile" onclick="window.location.href='../login/login.html'">로그인</button>
                <!-- Mobile Nickname Display -->
                <div class="user-nickname-mobile" id="userNicknameMobile"></div>
            </nav>

            <!-- Desktop Login Button -->
            <button class="login-btn login-btn-desktop" onclick="window.location.href='../login/login.html'">로그인</button>
            <!-- Desktop Nickname Display -->
            <div class="user-nickname-desktop" id="userNicknameDesktop"></div>
            </div>
        </header>
        <!-- End Header -->
    
        <!-- Header Script -->
        <script>
            // Mobile menu toggle
            const menuBtn = document.querySelector('.menu-btn');
            const nav = document.querySelector('.nav');
            const overlay = document.querySelector('.menu-overlay');
            
            menuBtn.addEventListener('click', () => {
                nav.classList.toggle('active');
                menuBtn.classList.toggle('active');
                overlay.classList.toggle('active');
            });
    
            // 오버레이 클릭 시 메뉴 닫기
            overlay.addEventListener('click', () => {
                nav.classList.remove('active');
                menuBtn.classList.remove('active');
                overlay.classList.remove('active');
            });

            // 닉네임 표시 로직 (데스크톱만)
            function updateHeaderWithNickname() {
                const userNickname = localStorage.getItem('userNickname');
                const loginBtnDesktop = document.querySelector('.login-btn-desktop');
                const nicknameDesktop = document.getElementById('userNicknameDesktop');
                
                if (userNickname) {
                    // 닉네임이 있으면 데스크톱 로그인 버튼 숨기고 닉네임 표시
                    loginBtnDesktop.classList.add('hidden');
                    nicknameDesktop.textContent = userNickname;
                    nicknameDesktop.classList.add('show');
                } else {
                    // 닉네임이 없으면 로그인 버튼 표시
                    loginBtnDesktop.classList.remove('hidden');
                    nicknameDesktop.classList.remove('show');
                }
            }
            
            // 페이지 로드 시 닉네임 확인
            updateHeaderWithNickname();

            // ===== 사용자 활동 추적 및 자동 로그아웃 (5분) =====
            let inactivityTimer;
            const INACTIVITY_TIMEOUT = 5 * 60 * 1000; // 5분

            function resetInactivityTimer() {
                clearTimeout(inactivityTimer);
                inactivityTimer = setTimeout(() => {
                    // 5분간 활동이 없으면 닉네임 삭제 및 UI 업데이트
                    localStorage.removeItem('userNickname');
                    updateHeaderWithNickname();
                    updateLogoutButton();
                }, INACTIVITY_TIMEOUT);
            }

            // 사용자 활동 감지 이벤트들
            ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
                document.addEventListener(event, resetInactivityTimer, true);
            });

            // 페이지 로드 시 타이머 시작
            resetInactivityTimer();
        </script>
    
        <!-- ============================================ -->
        <!-- HEADER END -->
        <!-- ============================================ -->
    
        <!-- Quiz Content -->
        <div class="quiz-container">
            <!-- 초승달 이미지 -->
            <img src="../sub/img/초승달.webp" alt="초승달" class="quiz-moon-image">

            <!-- 첫 번째 텍스트 -->
            <h1 class="quiz-main-title">
                <span class="moony-text">
                    <img src="../img/MOONY.webp" alt="MOONY 로고">
                </span>
                <span class="regular-text">로</span><br><span class="regular-text">많이 공부하셨나요?</span>
            </h1>

            <!-- 두 번째 텍스트 -->
            <p class="quiz-subtitle">
                달을 얼마나 잘 알고있는지<br>퀴즈로 확인해봐요!
            </p>

            <!-- 버튼 -->
            <button class="quiz-start-btn" onclick="checkLoginAndStart()">
                <span>퀴즈 시작!</span>
            </button>
        </div>

        <!-- 로그아웃 버튼 (닉네임이 있을 때만 표시) -->
        <button class="logout-btn" id="logoutBtn" onclick="handleLogout()" aria-label="로그아웃">
            <span>&times;</span>
        </button>

        <script>
            // 로그아웃 버튼 표시/숨김 업데이트
            function updateLogoutButton() {
                const userNickname = localStorage.getItem('userNickname');
                const logoutBtn = document.getElementById('logoutBtn');
                
                if (userNickname) {
                    logoutBtn.classList.add('show');
                } else {
                    logoutBtn.classList.remove('show');
                }
            }

            // 로그아웃 처리
            function handleLogout() {
                if (confirm('로그아웃 하시겠습니까?')) {
                    localStorage.removeItem('userNickname');
                    updateHeaderWithNickname();
                    updateLogoutButton();
                }
            }

            // 페이지 로드 시 로그아웃 버튼 상태 업데이트
            updateLogoutButton();
        </script>

        <!-- 로그인 팝업 모달 -->
        <div class="login-popup-overlay" id="loginPopup">
            <div class="login-popup-content">
                <div class="login-glass-box-popup">
                    <!-- 닫기 버튼 -->
                    <button class="login-popup-close" onclick="closeLoginPopup()">&times;</button>

                    <!-- 로그인 폼 -->
                    <form class="login-form-popup" id="loginFormPopup">
                        <!-- 제목 -->
                        <h1 class="login-title-popup">닉네임을 입력해주세요</h1>
                        
                        <!-- 닉네임 입력 필드 -->
                        <div class="login-input-wrapper-popup">
                            <input 
                                type="text" 
                                class="login-input-popup" 
                                id="nicknameInputPopup"
                                placeholder="닉네임#6자리 숫자"
                                autocomplete="off"
                            >
                        </div>
                        
                        <!-- 에러 메시지 -->
                        <div class="login-error-popup" id="loginErrorPopup">
                            닉네임 형식이 올바르지 않습니다. (예: moony#123456)
                        </div>
                        
                        <!-- 로그인 버튼 -->
                        <button type="submit" class="login-submit-btn-popup">로그인</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 로그인 체크 및 팝업 스크립트 -->
        <script>
            // 로그인 체크 및 퀴즈 시작
            function checkLoginAndStart() {
                const userNickname = localStorage.getItem('userNickname');
                
                if (!userNickname) {
                    // 닉네임이 없으면 팝업 띄우기
                    document.getElementById('loginPopup').style.display = 'flex';
                } else {
                    // 닉네임이 있으면 퀴즈 시작
                    location.href = './question1/question1.html';
                }
            }

            // 팝업 닫기
            function closeLoginPopup() {
                document.getElementById('loginPopup').style.display = 'none';
            }

            // 팝업 외부 클릭 시 닫기
            document.getElementById('loginPopup').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeLoginPopup();
                }
            });

            // 팝업 로그인 폼 처리
            const loginFormPopup = document.getElementById('loginFormPopup');
            const nicknameInputPopup = document.getElementById('nicknameInputPopup');
            const loginErrorPopup = document.getElementById('loginErrorPopup');
            
            // 닉네임 형식 검증 (닉네임#6자리 숫자)
            function validateNickname(nickname) {
                const pattern = /^.+#\d{6}$/;
                return pattern.test(nickname);
            }
            
            // 팝업 폼 제출 이벤트
            loginFormPopup.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const nickname = nicknameInputPopup.value.trim();
                
                if (validateNickname(nickname)) {
                    // 유효한 형식이면 localStorage에 저장하고 퀴즈 시작
                    localStorage.setItem('userNickname', nickname);
                    location.href = './question1/question1.html';
                } else {
                    // 에러 메시지 표시
                    loginErrorPopup.classList.add('show');
                    nicknameInputPopup.style.borderColor = 'rgba(255, 107, 107, 0.6)';
                    
                    // 3초 후 에러 메시지 숨김
                    setTimeout(() => {
                        loginErrorPopup.classList.remove('show');
                        nicknameInputPopup.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                    }, 3000);
                }
            });
            
            // 입력 필드 변경 시 에러 메시지 숨김
            nicknameInputPopup.addEventListener('input', function() {
                if (loginErrorPopup.classList.contains('show')) {
                    loginErrorPopup.classList.remove('show');
                    nicknameInputPopup.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                }
            });
        </script>
    
</body>
</html>